<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Parcel Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* Base: full viewport, prevent body-level scrolling so layout fits one screen */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #f5f6fb;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-tap-highlight-color: transparent;
    }

    .navbar {
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      z-index: 1060;
      height: 58px; /* slightly smaller on mobile */
      padding: 6px 12px;
    }

    .navbar-brand { font-weight: 700; font-size: 1.25rem; color: #1a1a1a; }

    /* Root layout: column flex, split into top (QR+OTP), middle (status), bottom (details+actions) */
    .page-root {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 58px);
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
      padding: 10px;
      box-sizing: border-box;
    }

    .card-custom {
      width: 100%;
      max-width: 720px;
      height: 100%;
      border-radius: 14px;
      box-shadow: 0 6px 30px rgba(10, 25, 47, 0.06);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
      box-sizing: border-box;
    }

    /* TOP area: for mobile we stack QR above OTP */
    .top-area {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      padding: 6px;
      flex: 0 0 auto;
      width: 100%;
    }

    .qr-img {
      width: clamp(170px, 36vw, 340px);
      height: auto;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(13, 110, 253, 0.12);
      padding: 8px;
      background: #fff;
      flex-shrink: 0;
    }

    .otp-box {
      font-size: clamp(20px, 5.5vw, 34px);
      font-weight: 800;
      color: #0d6efd;
      border: 3px dashed #0d6efd;
      padding: 10px 18px;
      border-radius: 0.75rem;
      display: inline-block;
      background-color: #f8f9ff;
      min-width: 170px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(13,110,253,0.06);
    }

    .middle-area { flex: 0 0 auto; display:flex; width:100%; }
    .middle-area .alert { width:100%; margin:0; border-radius:10px; font-size:0.95rem; }

    .bottom-area {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 6px;
      flex: 1 1 auto;
      overflow: hidden;
    }

    /* Allow details to scroll internally if needed (so the whole page doesn't) */
    .details {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px;
      background: rgba(250,250,255,0.6);
      border-radius: 10px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
      flex: 1 1 auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    .details p { margin:0; font-size: 0.95rem; }

    .action-buttons { display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .action-buttons button, .action-buttons a { min-width: 140px; }

    .bottom-links { display:flex; justify-content:center; align-items:center; gap:12px; padding:4px 0; flex-shrink:0; }

    /* MOBILE-FRIENDLY: for small widths, stack and enlarge tappable areas */
    @media (max-width: 480px) {
      .page-root { padding: 8px; }
      .top-area { flex-direction: column; gap: 10px; }
      .qr-img { width: min(68vw, 320px); }
      .otp-box { font-size: clamp(22px, 7vw, 40px); padding: 12px 20px; }
      .navbar-brand { font-size: 1.05rem; }
      .action-buttons { flex-direction: column; padding-bottom: 6px; }
      .action-buttons button, .action-buttons a { width: 100%; min-width: 0; }
      .details { padding: 8px; font-size: 0.95rem; }
      .card-custom { border-radius: 12px; padding: 8px; }
    }

    /* VERY SMALL HEIGHT devices (old phones) reduce some spacing */
    @media (max-height: 640px) {
      .navbar { height: 52px; }
      .page-root { height: calc(100vh - 52px); }
      .otp-box { padding: 8px 14px; }
      .qr-img { width: clamp(140px, 40vw, 260px); }
    }

  </style>
</head>

<body>
  <nav class="navbar navbar-light px-2 py-1 sticky-top shadow-sm">
    <div class="d-flex align-items-center w-100 justify-content-between">
      <div class="d-flex align-items-center">
        <a href="/mobileDashboard" class="btn btn-link p-0 me-2" style="font-size: 1.1rem; color: #333;">
          <i class="fas fa-arrow-left"></i>
        </a>
        <a class="navbar-brand d-flex align-items-center mb-0" href="/mobileDashboard">
          <img src="/uploads/mobile-logo.png" alt="Logo" height="34" class="me-2 d-none d-sm-inline" />
          <span>DropPoint</span>
        </a>
      </div>

      <div class="dropdown">
        <a href="#" class="d-flex align-items-center justify-content-center rounded-circle bg-light shadow-sm p-2"
          id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="width: 40px; height: 40px;">
          <i class="fa-solid fa-user fa-lg" style="color: #f6a534;"></i>
        </a>
        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3" aria-labelledby="userDropdown">
          <li><a class="dropdown-item d-flex align-items-center gap-2" href="/mobileDashboard"><i class="fa-solid fa-house text-primary"></i> Home</a></li>
          <li><a class="dropdown-item d-flex align-items-center gap-2" href="/mobileAccount"><i class="fa-solid fa-user-gear text-success"></i> Profile</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item d-flex align-items-center gap-2 text-danger" href="/logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="page-root">
    <div class="card-custom">

      <!-- TOP: QR and OTP -->
      <div class="top-area">
        <img src="<%= parcel.qrImage %>" alt="QR Code" class="qr-img" />
        <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
          <h5 class="mb-0" style="font-weight:700;color:#0f5132;">âœ… Parcel Booked</h5>
          <div class="otp-box" id="otpBox"><%= parcel.accessCode %></div>
          <!-- make OTP copyable on tap for mobile -->
          <button id="copyOtpBtn" class="btn btn-sm btn-outline-secondary mt-1" style="display:none;">Copy OTP</button>
        </div>
      </div>

      <!-- Middle: status -->
      <div class="middle-area">
        <% if (parcel.paymentOption === "receiver_pays") { %>
          <div class="alert alert-warning mb-0 w-100 text-center">ðŸš§ Waiting for receiver's payment. You'll be notified once they pay.</div>
        <% } else { %>
          <div class="alert alert-success mb-0 w-100 text-center">âœ… QR is active! Drop your parcel at any nearby locker by scanning it.</div>
        <% } %>
      </div>

      <!-- BOTTOM: details and actions -->
      <div class="bottom-area">
        <div class="details">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <h4 class="fw-bold mb-1">Parcel Details</h4>
            <small class="text-muted">Expires: <%= new Date(parcel.expiresAt).toLocaleString("en-IN", { timeZone: "Asia/Kolkata" }) %></small>
          </div>

          <p><strong>Type:</strong> <%= parcel.type %></p>
          <p><strong>Size:</strong> <%= parcel.size %></p>
          <p><strong>Receiver:</strong> <%= parcel.receiverName %> (<%= parcel.receiverPhone %>)</p>

          <div style="margin-top:8px;"><h6 class="mb-1">Instructions</h6>
            <p class="text-muted" style="font-size:0.95rem;">Scan the QR code at any DropPoint locker and enter the OTP if prompted. Keep this link or QR accessible to the receiver if they are paying or collecting.</p>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-success" onclick="shareQR()"><i class="fas fa-share-alt me-1"></i> Share QR</button>
          <button class="btn btn-outline-secondary" onclick='copyLink(`https://demo.droppoint.in/mobile/view/parcel/<%- parcel._id %>/success`)'><i class="fas fa-copy me-1"></i> Copy Link</button>
          <a href="/mobileDashboard" class="btn btn-primary">Back to Dashboard</a>
        </div>

        <div class="bottom-links"><small class="text-muted">Need help? Contact support or visit the dashboard.</small></div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    /* Share and analytics retained */
    function shareQR() {
      if (navigator.share) {
        navigator.share({
          title: "ðŸ“¦ Your Parcel QR",
          text: "Scan this QR at any locker to drop your parcel.",
          url: "https://demo.droppoint.in/mobile/view/parcel/<%- parcel._id %>/success"
        }).catch(console.error);
      } else {
        alert("Your browser doesn't support Web Share.");
      }
    }
    function trackUserAction(step, method = 'pageview') {
      fetch('/analytics/user-action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ step, method, path: window.location.pathname })
      });
    }
    trackUserAction('payment_completed');
    trackUserAction('parcel_booked');

    function copyLink(url) {
      if (!url) return alert("âŒ URL not found");
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => showToast('âœ… Link copied to clipboard')).catch(() => fallbackCopy(url));
      } else fallbackCopy(url);

      function fallbackCopy(text) {
        const tempInput = document.createElement('input');
        tempInput.value = text; document.body.appendChild(tempInput);
        tempInput.select(); document.execCommand('copy'); document.body.removeChild(tempInput);
        showToast('âœ… Link copied to clipboard');
      }
    }

    function showToast(msg) { alert(msg); }

    /* Make OTP copyable on tap for mobile users */
    const otpBox = document.getElementById('otpBox');
    if (otpBox) {
      otpBox.addEventListener('click', () => {
        const text = otpBox.textContent.trim();
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(() => showToast('âœ… OTP copied')).catch(() => showToast('Failed to copy'));
        } else {
          const t = document.createElement('input'); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); showToast('âœ… OTP copied');
        }
      });
    }
  </script>

</body>

</html>